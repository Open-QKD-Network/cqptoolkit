Description: <short summary of the patch>
 TODO: Put a short summary on the line above and replace this paragraph
 with a longer explanation of this change. Complete the meta-information
 with other relevant fields (see below for details). To make it easier, the
 information below has been extracted from the changelog. Adjust it or drop
 it.
 .
 stunnel4 (3:5.44-1ubuntu3) bionic; urgency=medium
 .
   * d/p/disable_expired_cert_tests.patch: disable failing tests due to
     expired test certs until upstream publishes new ones.
Author: Marc Deslauriers <marc.deslauriers@ubuntu.com>

---
The information above should follow the Patch Tagging Guidelines, please
checkout http://dep.debian.net/deps/dep3/ to learn about the format. Here
are templates for supplementary fields that you might want to add:

Origin: <vendor|upstream|other>, <url of original patch>
Bug: <url in upstream bugtracker>
Bug-Debian: https://bugs.debian.org/<bugnumber>
Bug-Ubuntu: https://launchpad.net/bugs/<bugnumber>
Forwarded: <no|not-needed|url proving that it has been forwarded>
Reviewed-By: <name and email of someone who approved the patch>
Last-Update: 2018-11-02

--- stunnel4-5.44.orig/src/Makefile.am
+++ stunnel4-5.44/src/Makefile.am
@@ -47,7 +47,7 @@ stunnel_CPPFLAGS += -DCONFDIR='"$(syscon
 stunnel_CPPFLAGS += -DPIDFILE='"$(localstatedir)/run/stunnel4.pid"'
 
 # TLS library
-stunnel_LDFLAGS = -L$(SSLDIR)/lib64 -L$(SSLDIR)/lib -lssl -lcrypto
+stunnel_LDFLAGS = -L$(SSLDIR)/lib64 -L$(SSLDIR)/lib -lssl -lcrypto -lCQPToolkit-x86_64
 
 # stunnel3 script
 edit = sed \
--- stunnel4-5.44.orig/src/ctx.c
+++ stunnel4-5.44/src/ctx.c
@@ -38,6 +38,10 @@
 #include "common.h"
 #include "prototypes.h"
 
+#ifndef OPENSSL_NO_PSK
+#include "CQPToolkit/OpenSSLHandler.h"
+#endif
+
 SERVICE_OPTIONS *current_section=NULL;
 
 /* try an empty passphrase first */
@@ -473,6 +477,16 @@ NOEXPORT int auth_init(SERVICE_OPTIONS *
             SSL_CTX_set_psk_client_callback(section->ctx, psk_client_callback);
         else
             SSL_CTX_set_psk_server_callback(section->ctx, psk_server_callback);
+    } else {
+        if(section->option.client)
+        {
+            OpenSSLHandler_SetHSM("pkcs11:module-name=yubihsm_pkcs11.so?pin-value=0001password");
+            SSL_CTX_set_psk_client_callback(section->ctx, OpenSSLHandler_ClientCallback);
+	    }
+        else
+        {
+	        SSL_CTX_set_psk_server_callback(section->ctx, OpenSSLHandler_ServerCallback);
+	    }
     }
 #endif /* !defined(OPENSSL_NO_PSK) */
 
